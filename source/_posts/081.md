---
title: A simple way to build Trojan service on Debian
date: 2019-09-27 22:10:15
tags: trojan
categories: Other
description: 
cover: /Depository/Img/Post/0028.png
top_img: /Depository/Img/Post/0027.jpg
---


**<center>A simple way to nuild Trojan service on Debian</center>**


本文   仅供参考！仅供参考！仅供参考！

本文为在debian搭建trojan精简方法，详细搭建trojan教程请参考[自建梯子教程 --Trojan版本](https://trojan-tutor.github.io/2019/04/10/p41.html)


---

### Trojan工作原理浅析

![Trojan工作原理浅析](https://everetthuang.github.io/Depository/Img/Post/0029.png "Trojan工作原理解析")

---

### 安装trojan服务

*搭建前请自行购买VPS，购买域名，并将域名解析到VPS对应的IP上*

```bash
apt install trojan
```

---

### 安装acme脚本获取证书

***以下申请证书步骤中<tdom.ml>均改为自己的域名***


```bash
apt install curl socat
```

```bash
curl  https://get.acme.sh | sh
```

#### 使用cloudflare DNS验证的情况

**1.添加cloudflare Global CA Key**

登录cloudflare之后定位到：头像>>My Profile>>API Tokens。找到Global API Key，点击View即可查看，注意查看之后自己保存下来，每天可查看次数是有限制的。

```bash
export CF_Key="<Your Global API Key>"
export CF_Email="<Your cloudflare account Email>"
```

**2.申请证书**

```bash
~/.acme.sh/acme.sh --issue --dns dns_cf -d <tdom.ml> -k ec-384
```
*执行完以后最后几行全是绿色字体即为申请成功*

**3.安装证书**

安装证书到`/etc/trojan/`路径：

```bash
~/.acme.sh/acme.sh --install-cert -d <tdom.ml> --key-file /etc/trojan/private.key --fullchain-file /etc/trojan/certificate.crt --ecc
```

**4.配置证书自动更新及赋予证书和trojan配置文件700权限：**

```bash
~/.acme.sh/acme.sh  --upgrade  --auto-upgrade
```


```bash
chmod -R 777 /etc/trojan/
```

#### 不使用cloudflare DNS验证的情况：

**1.申请证书**

```bash
~/.acme.sh/acme.sh --issue -d <tdom.ml> --standalone -k ec-384
```
*执行完以后最后几行全是绿色字体即为申请成功*

**2.安装证书**

安装证书到`/etc/trojan/`路径：

```bash
~/.acme.sh/acme.sh --installcert -d <tdom.ml> --fullchainpath /etc/trojan/certificate.crt --keypath /etc/trojan/private.key --ecc
```

**3.配置证书自动更新及赋予证书和trojan配置文件700权限：**

```bash
~/.acme.sh/acme.sh  --upgrade  --auto-upgrade
chmod -R 777 /etc/trojan/
```

---

### 配置nginx


将`default`中的域名和ip改成自己的：

```bash
apt install nginx
```


```bash
vi /etc/nginx/sites-available/default
```

```
server {
    listen 127.0.0.1:80 http2 default_server;

    server_name <tdom.ml>;

    location / {
#       root /var/www/html;
#       index index.html;
        proxy_pass https://everett.ml;
    }

}

server {
    listen 127.0.0.1:80;

    server_name <www.tdom.ml> <10.10.10.10>;

    return 301 https://<tdom.ml>$request_uri;
}
#server {
#    listen 80;
#    listen [::]:80;
#
#    server_name <www.tdom.ml> <10.10.10.10> <tdom.ml>;
#
#    return 301 https://<tdom.ml>$request_uri;
#}
```

---

### 运行trojan及nginx并设置开机自启

**1.启动trojan及重启nginx**

```bash
systemctl start trojan
```


```bash
systemctl restart nginx
```

**2.查看nginx和trojan运行状态**

```bash
systemctl status trojan
```



```bash
systemctl status nginx
```

*如果nginx或者trojan服务未正常运行，查看状态时会显示未运行原因(一般为没有权限读取配置文件或配置文件中出现中文符号错误)，按提示解决即可*

**3.设置trojan开机自启**

```bash
systemctl enable trojan
```

---

### 启用BBR


*bbr是谷歌开发的网络控制算法，可以加快访问速度*

执行下面命令查看当前系统是否启用bbr(如果提示`net.ipv4.tcp_congestion_control = bbr`即表示启动了bbr)

```bash
sysctl net.ipv4.tcp_congestion_control 
```

*如果执行上述命令显示开启了BBR，跳过启动BBR步骤*

直接将下面三条命令拷贝粘贴到Xshell里面执行即可启动bbr，检查启动状态同上


```bash
bash -c 'echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf'
```

```bash
bash -c 'echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf'
```

```bash
sysctl -p
```

---

### 配置防火墙

*只打开ssh、80和443端口可以有效的阻止外部恶意流量，降低服务器暴露的风险(自己有其他服务记得其他服务的端口也要处理)*

**1.安装ufw**

*ufw是一个很好用的防火墙配置命令*

```bash
apt install ufw
```

*如果服务器无IPv6地址那么需要执行如下命令，将`IPV6=yes`修改为`IPV6=no`*

```bash
vi /etc/default/ufw
```

**2.执行如下命令即可成功配置防火墙**

*注意，如果ssh端口不是22那么将ssh改为端口号*

```bash
ufw allow ssh
```

```bash
ufw allow https
```

```bash
ufw allow http
```

```bash
ufw enable
```

```bash
ufw status
```

```bash
ufw status verbose
```

---

### 其他问题

1.搬瓦工debian10目前有个小BUG，需要将`/etc/network/interfaces`中最后`eth1`两行注释或者删除才可正常使用

---

### snell proxy

zip-url：https://github.com/surge-networks/snell/releases/download/v2.0.3/snell-server-v2.0.3-linux-amd64.zip

可上github页面获取最新版本和其他系统版本 ： https://github.com/surge-networks/snell/releases

1. unzip snell-server-v2.0.3-linux-amd64.zip

2. 创建systemd service配置(snell官方有现成的配置可用：https://raw.githubusercontent.com/surge-networks/snell/master/systemd-example)
  
   将systemd service配置放入/lib/systemd/system/snell.service文件中，该配置里包含snell的运行文件和配置文件路径

wget https://raw.githubusercontent.com/surge-networks/snell/master/systemd-example Move to /lib/systemd/system/snell.service

3. 将snell-server-v2.0.3-linux-amd64.zip中解压的snell-server Move to /usr/local/bin/snell-server

4. 将snell-server-v2.0.3-linux-amd64.zip中解压的snell-server.conf MOve to /etc/snell-server.conf

5. snell配置文件/etc/snell-server.conf里面可修改密码端口号混淆等

6. 可用systemctl相关命令启动和开机自启snell

```
https://github.com/EverettHuang/SeeTheWorld
```

>相关链接

* [自建梯子教程 --Trojan版本](https://trojan-tutor.github.io/2019/04/10/p41.html)

* [Trojan-Panel配置](https://trojan-tutor.github.io/2019/06/08/p43.html)

* [trojan项目Github地址](https://github.com/trojan-gfw/trojan)

---
