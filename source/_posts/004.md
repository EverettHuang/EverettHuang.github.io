---
title: Linux账户与系统安全
date: 2019-10-14 12:34:46
tags: Linux
categories: Linux
description: 
cover: /Depository/Img/Post/
top_img: /Depository/Img/Post/
---

**<center>Linux账户与系统安全</center>**



#### 账户

* 管理员UID为0：系统的管理员用户
* 系统用户UID为1～999：Linux系统为了避免因某个服务程序出现漏洞而被黑客提权至整台服务器，默认服务程序会有独立的系统用户负责运行，进而有效控制被破坏范围
* 普通用户UID从1000开始：是由管理员创建的用于日常工作的用户
* UID不能冲突，管理员创建的普通用户的UID默认从1000开始，即使前面有闲置的号码

组

分为基础组和附加组，一个用户同一时间只能加入一个基本组，但可同时加入多个附加组

创建用户时，会默认创建同名组，并设置用户加入该基本组

##### useradd(创建用户账户)

* description  :  创建用户账户
* synopsis  :  useradd [option] username
* [option]  :
  * None  :  
  * -c  :  设置账户描述信息，一般为账户全称
  * -d  :  设置账户家目录，默认为/home/$USER
  * -e  :  设置账户失效日期，格式为YYYY-MM-DD
  * -g  :  设置账户的基本组
  * -G  :  设置账户的附加组，多附加组之间用逗号隔开
  * -M  :  不创建用户家目录
  * -s  :  设置账户的登陆shell，默认为bash
  * -u  :  指定用户UID

##### groupadd(创建组账户)

* description  :  创建组账户
* synopsis  :  groupadd [option] groupname
* [option]  :
  * None  :
  * -g  :  设置组账户ID号

##### id

* description  :  显示账户及组信息
* synopsis  :  id username

##### passwd(更新账户认证信息)

* description  :  更新账户认证信息
* synopsis  :  passwd [option] username
* [option]  :
  * None  :  为当前用户设置新密码
  * -l  :  锁定账户，仅root可使用该选项
  * --stdin  :  允许通过标准输入修改用户密码(文件或管道读取密码)
  * -u  :  解锁账户
  * -d  :  快速清空账户密码，该用户可空密码登陆，仅root可使用该选项
  * -e  :  强制用户在下次登陆时修改密码
  * -s  :  显示用户的密码是否被锁定，以及密码所采用的加密算法名称
##### usermod(修改用户的属性)

* description  :  修改用户的属性
* synopsis  :  usermod [option] username
* [option]  :
  * None  :
  * -c  :  填写用户的备注信息
  * -d/-m  :  一般同时使用，-d选项重新指定用户的家目录，-m把旧数据转移过去
  * -e  :  账户的到期时间，格式为YYYY-MM-DD
  * -g  :  变更所属用户组
  * -G  :  变更拓展用户组
  * -L  :  锁定用户禁止其登陆系统
  * -U  :  解锁用户，允许其登陆系统
  * -s  :  变更默认终端
  * -u  :  修改用户UID

##### userdel(删除用户)

* description  :  删除用户
* synopsis  :  userdel [option] username
* [option]  :
  * None  :  删除账户但账户的文件不删除
  * -f  :  强制删除用户
  * -r  :  同时删除用户及用户家目录

##### groupdel(删除组账户)

* description  :  删除组账户
* synopsis  :  groupdel [option] groupname
* [option]  :


##### 账户文件

* /etc/passwd  :  用户账户信息文件
* /etc/shadow  :  用户账户密码文件
* /etc/group  :  组信息文件
* /etc/gshadow  :  组账户密码文件

#### 权限

##### 普通权限


Linux权限主要分为可读(r,4)，可写(w,2)，可执行(x,1)三种

* 对目录文件来说，可读表示能够读取目录内的文件列表；可写表示能够在目录内新增，删除，重命名文件；而可执行则表示能够进入该目录

表：文件权限的字符与数字表示

权限项 | 读 | 写 | 执行
:-: | :-: | :-: | :-:
字符表示 | r | w | x
数字表示 | 4 | 2 | 1

* 文件权限的数字法表示基于字符表示(rwx)的权限计算而来，例7代表可读可写可执行(4+2+1)
* rwxrw-r--数字表示法为764(764这三个数字分表表示文件所有者，文件所属组和其他用户的权限，不可再相加)
* ls -l显示文件详细信息，会显示文件的类型，访问权限，所有者，所属组，占用磁盘大小，修改时间和文件名称等信息

chmod(修改文件或目录属性)

* description  :  修改文件属性
* synopsis  :  chmod [option] 权限 file/folder
* [option] :
  * None  :
  * --reference=RFILE  :  根据参考文档设置权限
  * -R  :  递归将权限应用于所有的子目录与子文件
* 权限  ：
  *  使用完整的权限表示
  *  可用(u,g,o,a)(=,+,-)(w,r,x,4,2,1,t)来表示修改权限
* Tips  :  chmod中，u代表所有者，g代表所属组，o代表其他用户，a代表所有用户

chown(修改文件或目录的所有者与所属组)

* description  :  修改文件或目录的所有者与所属组
* synopsis  :  chown [option] 所有者:所属组 file/folder
* [option]  :
  * None  :
  * -R  :  递归将权限应用于所有的子目录与子文件

##### 特殊权限

特殊权限可与一般权限同时使用，弥补一般权限不能实现的功能

* SUID

SUID是一种对二进制程序进行设置的特殊权限，可以让二进制程序的执行者临时拥有属主的权限(仅对拥有执行权限的二进制程序有效)

拥有SUID权限时，文件的所有者部分的x权限会变为s；如果原本原本权限没有x,则会显示为大写的S

* SGID

SGID主要有两种功能：1,让执行者临时拥有属组的权限(对拥有执行权限的二进制程序进行设置)；2，在某个目录中创建的文件自动继承该目录的用户组(只可以对目录进行设置)

在目录上设置SGID权限后，在这个目录下创建的文件或目录都会继承这个目录的用户组，而不是创建目录或文件的操作用户

拥有SGID权限时，文件的所属组部分的x权限会变为s；


* SBIT

SBIT特殊权限位可确保用户只能删除自己的文件，而不能删除其他用户的文件(当对某个目录设置了SBIT粘滞位权限后，那么该目录中的文件就只能被其所有者执行删除操作了)

当目录被设置SBIT特殊权限位后，文件的其他人权限部分的x执行权限就会被替换成t或T，原本有x执行权限则会写成t，原本没有x执行权限则会被写成T

文件能否被删除并不取决于自身的权限，而是看其所在目录是否有写入权限

##### 隐藏权限

隐藏权限默认情况下不能直接被用户发觉

* chattr

* description  :  设置文件的隐藏权限
* synopsis  :  chattr [option] file
* [option]  :
  * i  :  无法对文件进行修改；若对目录设置了该参数，则仅能修改其中的子文件内容而不能新建或删除文件
  * a  :  仅允许补充(追加)内容，无法覆盖/删除内容(Append Only)
  * S  :  文件内容在变更后立即同步到硬盘
  * s  :  彻底从硬盘中删除，不可恢复(用0填充原文件所在硬盘区域)
  * A  :  不再修改这个文件或目录的最后访问时间
  * b  :  不再修改文件或目录的存取时间
  * D  :  检查压缩文件中的错误
  * d  :  使用dump命令备份时忽略本文件/目录
  * c  :  默认将文件或目录进行压缩
  * u  :  当删除该文件后依然保留其在硬盘中的数据，方便日后恢复
  * t  :  让文件系统支持尾部合并(tail-merging)
  * X  :  可以直接访问压缩文件中的内容
* Tips  :  如果想把某个隐藏功能添加到文件上，则需要在命令后追加“+参数”，如果需要把某个命令移除出文件，则需要追加“-参数ls 


* lsattr

* description  :  显示文件的隐藏属性
* synopsis  :  lsattr [option] file
* [option]  :
  * None  :
* Tips  :  可用lsattr显示文件的隐藏权限，此时可用chattr去掉权限

##### ACL访问控制列表

一般权限，特殊权限，隐藏权限都是针对某一类用户设置的

对某一个指定的用户进行单独的权限控制，就需要用到文件的访问控制列表(ACL)，基于普通文件或目录设置ACL其实就是针对指定的用户或用户组设置文件或目录的操作权限

如果针对某个目录设置了ACL，则目录中的文件会继承ACL；若针对文件设置了ACL，则文件不再继承所在目录的ACL

* setfacl
* description  :  管理文件的ACL规则
* synopsis  :  setfacl [option] u:username:权限 file
* [option]  :
  * -R  :  针对目录文件使用，递归参数
  * -m  :  普通文件使用
  * -b  :  删除ACL
* Tips  :  设置ACL权限后，在文件详细信息中权限最后一个.变为+号

---

* getfacl
* description  :  显示文件上设置的ACL信息
* synopsis  :  getfacl file

---

##### su命令和sudo服务

---

* su

可以使用su命令来切换当前用户，并且原用户不退出登录

* description  :  切换当前用户
* synopsis  :  su [-/None] [username/None]

su和用户名之间用加-时，表示完全切换到新的用户，即把环境变量信息也变更为新用户的相应信息，而不保留原是信息；root切换到普通用户不需要密码，普通用户切换到root用户需要密码

--

* sudo
* description  :  
* synopsis  :  sudo [option] 命令名称
* [option]  :
  * None  :
  * -h  :  列出帮助信息
  * -l  :  列出当前用户可执行的命令
  * -u 用户名/UID  :  以指定的用户身份执行命令
  * -k  :  清空密码的有效时间，下次执行sudo时需要再次进行密码验证
  * -b  :  在后台执行指定的指令
  * -p  :  更改询问密码的提示语
* Tips  :
  * 限制用户执行指定的命令
  * 记录用户执行的每一条命令
  * 配置文件(/etc/sudoers)提供集中的用户管理，权限与主机等参数
  * 验证密码5分钟内(默认值)无须再让用户再次验证密码
  * 可用visudo命令来配置用户权限(只有root才可以使用visudo命令，visudo基本操作和vim编辑器一样)
  * /etc/sudoers配置文件一行表示：谁可以使用 允许使用的主机=(以谁的身份) 可执行命令的列表
  * 可添加NOPASSWD参数，使得用户执行sudo命令时不再需要输入密码

---

#### SELinux

SELinux(Security-Enhanced Linux)是基于Linux内核的强访问控制机制(MAC)实现，它是由美国国家安全局开发的项目，旨在增强传统Linux操作系统的安全性

* 使用SELinux后，系统中的文件，目录，设备甚至是端口都作为对象，而用户运行的进程则被当作主题，一个主题能不能访问对象，首先系统会检查传统的账户权限是否允许(DAC控制权限)，如果传统的基于账户的访问权限允许，才会检查SELinux的强制访问控制(MAC访问控制)，SELinux依靠策略来决定是否允许主题访问目标对象

---

#### 防火墙

iptables为目前主流防火墙命令工具，nftables将逐步取代iptables

nftables及iptables都为用户命令行工具，其防火墙实现内核为netfilter，bpfilter将逐步取代netfilter

ufw为Ubuntu对iptables的高层封装实现
firewalld为Redhat对iptables的高层封装实现

---

* ufw 

如果是debian系系统，又对防火墙要求不高，可用最简单易用的ufw来管理防火墙规则

descriprion  :  
synopsis  :  ufw [option] Post
[option]  :
  * 

---

* nftables

地址族：ip , ipv6 , inet , arp , bridge , netdev

典型的nftables规则包含三个部分：表，链和规则

表是链和规则的容器；它们由其地址族和名称来标识；链包含inet/arp/bridge/netdev等协议所需的规则，并具有三种类型：过滤器，NAT和路由；nftables规则可以从脚本加载，也可以在终端键入，然后另存为规则集

对于家庭用户，默认链为过滤器。inet系列包含以下钩子：Input,Output,Forward,Pre-routing,Post-routing

nftables使用一个名为nft的程序来添加,创建,列出,删除和加载规则

nftables conntrackd netfilter-persistent

防火墙包含三部分：输入(input)，转发(forward)，输出(output)

基础操作

* 增
增加表：nft add table filter
增加链：nft add chain filter input {}
增加规则：nft add rule filter input tcp dport 22 accept

* 删
只需要将增加中的add改为delete即可

* 改
更改链名用rename
更改规则用replace

* 查
nft list ruleset #列出所有规则
nft list tables  #列出所有表
nft list table filter  #列出filter表
nft chain filter input  #列出filter表input链
#以上命令后面也可以加-nn用于不解析ip地址和端口
#加-a用于显示handles












---

* bpfilter




---

#### VPN

wireguard

wireguard是一个较新的高性能VPN，它设计精巧，核心代码仅四千多行，被Linux之父Linus称为“艺术品”

wireguard基于UDP传输

wireguard已经被集成进Linux5.6内核中(内核版本低于5.6需要安装)

##### 安装

安装以debian tseting版本为例：


```bash
sudo apt install wireguard
```

##### 开启IP转发

修改/etc/sysctl.conf文件

```bash
vi /etc/sysctl.conf
```

将`net.ipv4.ip_forward=1`前注释去掉，没有就添加该内容

最后用`sysctl -p`命令使修改立即生效

Tips: centos7需要在`/usr/lib/sysctl.d/50-default.conf`中加入`net.ipv4.ip_forward=1`


##### 用wg命令生成秘钥对

```bash
wg genkey | tee privatekey | wg pubkey > publickey
# 先用wg生成私钥，再用wg根据私钥生成公钥
```

* base64加密
* 生成的为一对密钥对，配置wireguard时，服务端及每一个客户端各需要一对密钥对

##### 修改配置文件

配置文件为`/etc/wireguard/wg0.conf`

服务端配置文件

```wg0.config
# 配置文件中的wg配置文件名wg0对应配置文件中的wg0,配置文件中的eth0表示本机网卡名称，可用ifconfig查看那网卡名称
[Interface]
Address = (虚拟网络设备的内网IP地址)
SaveConfig = True
PrivateKey = 服务器私钥(私钥内容，不是文件名或路径)
ListenPort = 端口号
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARE -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARE -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
DNS = 
MTU = 1420
[Peer]
PublicKey = 客户端公钥(公钥内容，不是文件名或路径)
AllowedIPs = 
```

客户端配置文件

```wg0.conf
[Interface]
Address = 客户端ip地址
PrivateKey = 客户端密钥
ListenPort = 
MTU = 1420
DNS = (服务器ip地址或其它)
[Peer]
PublicKey = 服务器的公钥
Endpoint = (服务器IP地址:端口)
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
```

##### 启动wireguard服务

启动wireguard服务

```bash
wg-quick up wg0
```

停止wireguard服务

```bash
wg-quick down wg0
```

设置开机自动启动wireguard服务

```bash
sudo systemctl enable wg-quick@wg0
```

* Tips  :  如果出现配置失败无法连接网络等情况，检查防火墙